<%= form_with model: @character, builder: CharacterFormBuilder do |f| %>
  <fieldset id="setup" class="lifepath_entry">
    <legend><%= t ".setup" %></legend>
    <div class="field">
      <%= f.label :player %>
      <%= f.text_field :player, required: true %>
    </div>
    <div class="field">
      <%= f.label :name %>
      <%= f.text_field :name, required: true %>
    </div>
    <div class="field" data-controller="options-carousel">
      <%= f.label :role %>
      <button class="back" data-action="options-carousel#prev" type="button"></button>
      <%= f.text_field :role, list: "roles", readonly: true, data: { options_carousel_target: "field" } %>
      <button class="forward" data-action="options-carousel#next" type="button"></button>
      <datalist id="roles">
        <%= options_for_select Character::ROLES.map { |r| Character.human_attribute_name "role.#{r}" } %>
      </datalist>
    </div>
    
    <%= f.button(:next, value: "personals", class: "slanted-button next", data: { turbo: false }) { t(".next") } %>
  </fieldset>
  
  <fieldset id="personals" class="lifepath_entry">
    <legend><%= t ".personals" %></legend>
    <%= render "options_table", f: f, attr: :origins, collection: Character::ORIGINS %>
    <%= render "options_table", f: f, attr: :personality, collection: Character::PERSONALITIES %>

    <%# TODO: handle the extra description %>
    <div class="field" data-controller="options-table">
      <%= f.label :clothing %>
      <%= f.text_field :clothing, data: { options_table_target: "field" } %>
      <table class="options-table">
        <thead>
          <tr>
            <th><%= t ".roll" %></th>
            <th><%= Character.human_attribute_name :clothing %></th>
          </tr>
        </thead>
        <tbody>
          <% Character::CLOTHINGS.each do |roll, o| %>
            <%= tag.tr data: { options_table_target: "option", action: "click->options-table#pick" } do %>
              <%= tag.th Array(roll).join("&nthinsp;-&nthinsp;") %>
              <%= tag.td do %>
                <%= Character.human_attribute_name "clothing.#{o}" %>
                <i><%= t ".clothings.#{o}" %></i>
              <% end %>
            <% end %>
          <% end %>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2">
              <button type="button" class="slanted-button" data-action="options-table#pickAtRandom">
                <%= t ".random" %>
              </button>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
    
    <%= render "options_table", f: f, attr: :hairstyle, collection: Character::HAIRSTYLES %>
    <%= render "options_table", f: f, attr: :affectation, collection: Character::AFFECTATIONS %>
    <%= render "options_table", f: f, attr: :most_valued_thing, collection: Character::VALUED_THINGS %>
    <%= render "options_table", f: f, attr: :opinion_on_people, collection: Character::OPINIONS_ON_PEOPLE %>
    <%= render "options_table", f: f, attr: :most_valued_person, collection: Character::VALUED_PEOPLE %>
    <%= render "options_table", f: f, attr: :most_valued_possession, collection: Character::VALUED_POSSESSIONS %>
    
    <%= f.button(:next, value: "background", class: "slanted-button next", data: { turbo: false }) { t(".next") } %>
  </fieldset>
  
  <fieldset id="background" class="lifepath_entry">
    <legend><%= t ".background" %></legend>
    
    <%= render "options_table", f: f, attr: :original_background, collection: Character::ORIGINAL_BACKGROUNDS %>
    <%= render "options_table", f: f, attr: :childhood_environment, collection: Character::CHILDHOOD_ENVIRONMENTS %>
    <%= render "options_table", f: f, attr: :family_crisis, collection: Character::FAMILIY_CRISES %>

    <%= f.button(:next, value: "friends", class: "slanted-button next", data: { turbo: false }) { t(".next") } %>
  </fieldset>

  <fieldset id="friends" class="lifepath_entry">
    <legend><%= t ".friends_html", count: f.object.friends.count %></legend>
    
    <% f.object.friends.each_with_index do |friend, i| %>
      <%= f.fields_for :friends, friend do |friend_fields| %>
        <div class="field">
          <%= friend_fields.label :name, index: i %>
          <%= friend_fields.text_field :name, index: i, required: true %>
        </div>
        
        <fieldset class="secondary-fields">
          <%= render "options_table", f: friend_fields, attr: :origin, collection: Friend::ORIGINS %>
        </fieldset>
      <% end %>
    <% end %>
    
    <%= f.button(:next, value: "enemies", class: "slanted-button next", data: { turbo: false }) { t(".next") } %>
  </fieldset>

  <fieldset id="enemies" class="lifepath_entry">
    <legend><%= t ".enemies_html", count: f.object.enemies.count %></legend>
    
    <% f.object.enemies.each_with_index do |enemy, i| %>
      <%= f.fields_for :enemies, enemy do |enemy_fields| %>
        <div class="field">
          <%= enemy_fields.label :name, index: i %>
          <%= enemy_fields.text_field :name, index: i, required: true %>
        </div>
        
        <fieldset class="secondary-fields">
          <%= render "options_table", f: enemy_fields, attr: :origin, collection: Enemy::ORIGINS %>
          <%= render "options_table", f: enemy_fields, attr: :cause, collection: Enemy::CAUSES %>
          
          <div class="field" data-controller="options-carousel">
            <%= enemy_fields.label :wronged_party %>
            
            <button class="back" data-action="options-carousel#prev" type="button"></button>
            <%= enemy_fields.text_field :wronged_party, list: "wronged_party_#{i}", readonly: true, data: { options_carousel_target: "field" } %>
            <button class="forward" data-action="options-carousel#next" type="button"></button>
            
            <datalist id="wronged_party_<%= i %>">
              <%= options_for_select %w[character enemy].map { |r| Enemy.human_attribute_name "wronged_party.#{r}" } %>
            </datalist>
          </div>
          
          <%= render "options_table", f: enemy_fields, attr: :means_of_retaliation, collection: Enemy::MEANS_OF_RETALIATION %>
          <%= render "options_table", f: enemy_fields, attr: :intensity, collection: Enemy::INTENSITIES %>
        </fieldset>
      <% end %>
    <% end %>
    
    <%= f.button(:next, value: "tragic_love_affairs", class: "slanted-button next", data: { turbo: false }) { t(".next") } %>
  </fieldset>

  <fieldset id="tragic-love-affairs" class="lifepath_entry">
    <legend><%= t ".tragic_love_affairs_html", count: f.object.tragic_love_affairs.count %></legend>
    
    <% f.object.tragic_love_affairs.each_with_index do |affair, i| %>
      <%= f.fields_for :tragic_love_affairs, affair do |affair_fields| %>
        <div class="field">
          <%= affair_fields.label :name, index: i %>
          <%= affair_fields.text_field :name, index: i, required: true %>
        </div>
        
        <fieldset class="secondary-fields">
          <%= render "options_table", f: affair_fields, attr: :origin, collection: TragicLoveAffair::ORIGINS %>
        </fieldset>
      <% end %>
    <% end %>
    
    <%= f.button(:next, value: "wrap-up", class: "slanted-button next", data: { turbo: false }) { t(".next") } %>
  </fieldset>

  
  <fieldset id="wrap-up" class="lifepath_entry">
    <legend><%= t ".wrap_up" %></legend>
    <%= render "options_table", f: f, attr: :life_goal, collection: Character::LIFE_GOALS %>
    
    <%= f.button(:next, value: "role-lifepath", class: "slanted-button next", data: { turbo: false }) { t(".next") } %>
  </fieldset>
  
  <fieldset id="role-lifepath" class="lifepath_entry">
    <legend><%= t ".role_lifepath" %></legend>
  </fieldset>
<% end %>
